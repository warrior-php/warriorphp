{% extends './layout.twig' %}

{% block wrapper %}
    <div id="main-wrapper" class="auth-customizer-none">
        <div class="position-relative overflow-hidden radial-gradient min-vh-100 w-100 d-flex align-items-center justify-content-center">
            <div class="d-flex align-items-center justify-content-center w-100">
                <div class="row justify-content-center w-100">
                    <div class="col-md-8 col-lg-6 col-xxl-3 auth-card">
                        <div class="text-nowrap logo-img text-center d-block mb-5 w-100">
                            <img src="{{ __ASSETS__('images/logos/dark-logo.svg') }}" class="dark-logo" alt="Logo-Dark"/>
                            <img src="{{ __ASSETS__('images/logos/light-logo.svg') }}" class="light-logo" alt="Logo-light"/>
                        </div>
                        <div class="card mb-0">
                            <div class="card-body">
                                <form action="{{ url('admin.login') }}" novalidate>
                                    <div class="mb-3 form-group">
                                        <label for="exampleInputUsername" class="form-label">{{ trans("admin.login.key1") }}</label>
                                        <div class="controls">
                                            <input id="exampleInputUsername" type="text" name="username" class="form-control" data-validation-required-message="{{ trans("admin.login.key8") }}"/>
                                        </div>
                                    </div>
                                    <div class="mb-3 form-group">
                                        <label for="exampleInputPassword" class="form-label">{{ trans("admin.login.key2") }}</label>
                                        <div class="controls">
                                            <input id="exampleInputPassword" type="password" name="password" class="form-control" data-validation-required-message="{{ trans("admin.login.key9") }}"/>
                                        </div>
                                    </div>
                                    <div class="mb-3 form-group">
                                        <label for="exampleInputCaptcha" class="form-label">{{ trans("admin.login.key10") }}</label>

                                        <div class="controls">
                                            <div class="input-group">
                                                <input id="exampleInputCaptcha" type="text" class="form-control" data-validation-required-message="{{ trans("admin.login.key11") }}"/>
                                                <img style="border-radius: 0 7px 7px 0; border: var(--bs-border-width) solid #dfe5ef;" id="captcha"
                                                     src="{{ url('captcha',{'type':'admin-login-captcha'}) }}" alt="{{ trans("admin.login.key10") }}"/>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center justify-content-between mb-4">
                                        <div class="form-check">
                                            <input class="form-check-input primary" type="checkbox" id="flexCheckChecked">
                                            <label class="form-check-label text-dark" for="flexCheckChecked">{{ trans("admin.login.key6") }}</label>
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-primary w-100 py-8 mb-4 rounded-1">{{ trans("admin.login.key7") }}</button>
                                </form>
                                <div class="position-relative text-center my-4">
                                    <p class="mb-0 fs-4 px-3 d-inline-block bg-body text-dark z-index-5 position-relative">{{ trans("admin.login.key3") }}</p>
                                    <span class="border-top w-100 position-absolute top-50 start-50 translate-middle"></span>
                                </div>
                                <div class="row">
                                    <div class="mb-2">
                                        <button class="btn w-100 text-dark border fw-normal d-flex align-items-center justify-content-center rounded-1 py-8">
                                            <img src="{{ __ASSETS__('images/svgs/google-icon.svg') }}" alt="modernize-img" class="img-fluid me-2" width="18" height="18">
                                            <span class="flex-shrink-0">{{ trans("admin.login.key4") }}</span>
                                        </button>
                                    </div>
                                    <div class="mt-2">
                                        <button class="btn w-100 text-dark border fw-normal d-flex align-items-center justify-content-center rounded-1 py-8">
                                            <img src="{{ __ASSETS__('images/svgs/facebook-icon.svg') }}" alt="modernize-img" class="img-fluid me-2" width="18" height="18">
                                            <span class="flex-shrink-0">{{ trans("admin.login.key5") }}</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="btn-group position-absolute" style="bottom: 20px; left: 10px;">
                <button type="button" class="btn border-0 dropdown-toggle d-flex align-items-center"
                        data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="10" fill="currentColor" opacity="0.5"/>
                        <path fill="currentColor"
                              d="M8.575 9.447C8.388 7.363 6.781 5.421 6 4.711l-.43-.37A9.96 9.96 0 0 1 12 2c2.214 0 4.26.72 5.916 1.936c.234.711-.212 2.196-.68 2.906c-.17.257-.554.577-.976.88c-.95.683-2.15 1.02-2.76 2.278a1.42 1.42 0 0 0-.083 1.016c.06.22.1.459.1.692c.002.755-.762 1.3-1.517 1.292c-1.964-.021-3.25-1.604-3.425-3.553m4.862 8.829c.988-1.862 4.281-1.862 4.281-1.862c3.432-.036 3.896-2.12 4.206-3.173a10.006 10.006 0 0 1-8.535 8.664c-.323-.68-.705-2.21.048-3.629"/>
                    </svg>
                    <span class="text-dark ms-1" id="currentLang">{{ (languages|filter(lang => lang.current)|first).name }}</span>
                </button>
                <ul class="dropdown-menu animated">
                    {% for lang in languages %}
                        <li>
                            <button class="dropdown-item d-flex justify-content-between align-items-center" data-lang="{{ lang.locale }}">
                                <span>{{ lang.name }}</span>
                                {% if lang.current %}
                                    <span class="checkmark">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                                            <path fill="none" stroke="#3370ff" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="m7 12.9l3.143 3.6L18 7.5"/>
                                        </svg>
                                    </span>
                                {% endif %}
                            </button>
                        </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
{% endblock %}

{% block js %}
    <script type="text/javascript">
        Do('base', () => {
            console.log(111);
        })
    </script>

    <script src="{{ __ASSETS__('js/extra-libs/jqbootstrapvalidation/validation.js') }}"></script>
    <script src="{{ __ASSETS__('js/forms/custom-validation-init.js') }}"></script>
    <script src="{{ __ASSETS__('js/request.js') }}"></script>
    <script>
        $('.dropdown-item').on('click', function () {
            const lang = $(this).data('lang');
            request.post('{{ url("setLang") }}', {
                lang: lang
            }).then(res => {
                if (res.code === 200) {
                    location.reload();
                }
            });
        });

        // 点击验证码图片时刷新
        $('#captcha').on('click', function () {
            refreshCaptcha(this);
        });

        function refreshCaptcha(selector) {
            const url = "{{ url('captcha',{'type':'admin-login-captcha'}) }}";
            const $el = typeof selector === 'string' ? $(selector) : $(selector);
            $el.attr('src', url + '?t=' + new Date().getTime());
        }

        $('form').on('submit', function (e) {
            e.preventDefault(); // 阻止默认提交

            const username = $.trim($('input[name="username"]').val());
            const password = $.trim($('input[name="password"]').val());
            const captcha = $.trim($('#exampleInputCaptcha').val());

            if (!username) {
                return alert("{{ trans('admin.login.key8') }}");
            }
            if (!password) {
                return alert("{{ trans('admin.login.key9') }}");
            }
            if (!captcha) {
                return alert("{{ trans('admin.login.key11') }}");
            }

            // 提交请求
            request.post('{{ url("admin.login") }}', {
                username,
                password,
                captcha
            }).then(res => {
                if (res.code === 200) {
                    // 登录成功
                    alert(res.msg || '登录成功');
                    // 跳转后台首页
                    location.href = res.url || '{{ url("admin.index") }}';
                } else {
                    // 登录失败
                    alert(res.msg || '登录失败');
                    refreshCaptcha('#captcha');
                }
            }).catch(err => {
                console.error(err);
                alert('网络错误，请稍后再试');
                refreshCaptcha('#captcha');
            });
        });
    </script>
{% endblock %}